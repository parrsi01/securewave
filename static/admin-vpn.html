<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VPN Administration - SecureWave</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/professional.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    .peer-card {
      background: var(--bg-primary);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .peer-card.pending {
      border-left: 4px solid var(--warning-500);
    }
    .peer-card.registered {
      border-left: 4px solid var(--success-500);
    }
    .peer-key {
      font-family: monospace;
      font-size: 0.75rem;
      background: var(--gray-100);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      word-break: break-all;
    }
    .command-box {
      background: var(--gray-900);
      color: var(--gray-100);
      padding: 1rem;
      border-radius: var(--radius-md);
      font-family: monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      position: relative;
    }
    .command-box .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--gray-700);
      border: none;
      color: var(--gray-300);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.7rem;
    }
    .command-box .copy-btn:hover {
      background: var(--gray-600);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 1rem;
      text-align: center;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-600);
    }
    .stat-card .label {
      font-size: 0.875rem;
      color: var(--gray-600);
    }
    .server-info {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .server-info dt {
      font-weight: 600;
      color: var(--primary-900);
    }
    .server-info dd {
      margin: 0 0 0.5rem 0;
      color: var(--primary-700);
      font-family: monospace;
    }
    .alert {
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
    }
    .alert.success {
      background: var(--success-50);
      border: 1px solid var(--success-200);
      color: var(--success-800);
    }
    .alert.error {
      background: var(--error-50);
      border: 1px solid var(--error-200);
      color: var(--error-800);
    }
    .alert.info {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      color: var(--primary-800);
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--gray-300);
      border-top-color: var(--primary-600);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <nav class="navbar">
    <div class="navbar-container">
      <a href="/home.html" class="navbar-brand">
        <img src="/img/logo.svg" alt="SecureWave VPN Logo">
        <span>SecureWave Admin</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/vpn.html">VPN Config</a></li>
        <li><a href="/admin-vpn.html" class="active">VPN Admin</a></li>
        <li><button class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button></li>
      </ul>
    </div>
  </nav>

  <main id="main-content">
    <section class="page-hero">
      <div class="container">
        <div class="badge">Admin Only</div>
        <h1 class="page-hero__title">VPN Administration</h1>
        <p class="page-hero__subtitle">
          Manage WireGuard peers and server configuration
        </p>
      </div>
    </section>

    <div class="container page-section">
      <!-- Access Check -->
      <div id="accessDenied" class="alert error hidden">
        Access denied. Admin privileges required.
        <a href="/dashboard.html">Return to Dashboard</a>
      </div>

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center; padding: 3rem;">
        <div class="loading" style="width: 2rem; height: 2rem;"></div>
        <p style="margin-top: 1rem; color: var(--gray-600);">Loading VPN data...</p>
      </div>

      <!-- Main Content (hidden until loaded) -->
      <div id="adminContent" class="hidden">
        <!-- Status Messages -->
        <div id="statusMessage" class="hidden"></div>

        <!-- Server Information -->
        <div class="server-info">
          <h2 style="margin: 0 0 1rem 0; font-size: 1.25rem;">Live WireGuard Server</h2>
          <dl style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem 2rem;">
            <div>
              <dt>Server ID</dt>
              <dd id="serverIdDisplay">-</dd>
            </div>
            <div>
              <dt>Public IP</dt>
              <dd id="serverIpDisplay">-</dd>
            </div>
            <div>
              <dt>WG Public Key</dt>
              <dd id="serverKeyDisplay" style="font-size: 0.65rem;">-</dd>
            </div>
            <div>
              <dt>Status</dt>
              <dd id="serverStatusDisplay">-</dd>
            </div>
          </dl>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="value" id="totalPeersCount">0</div>
            <div class="label">Total Peers</div>
          </div>
          <div class="stat-card">
            <div class="value" id="pendingPeersCount">0</div>
            <div class="label">Pending Registration</div>
          </div>
          <div class="stat-card">
            <div class="value" id="registeredPeersCount">0</div>
            <div class="label">Registered</div>
          </div>
          <div class="stat-card">
            <div class="value" id="serverCount">0</div>
            <div class="label">Servers</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="card" style="margin-bottom: 2rem;">
          <div class="card-body">
            <h2 style="margin: 0 0 1rem 0;">Quick Actions</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
              <button id="registerAllBtn" class="btn btn-primary">
                Register All Pending Peers
              </button>
              <button id="refreshBtn" class="btn btn-secondary">
                Refresh Data
              </button>
              <button id="showBulkCommandBtn" class="btn btn-outline">
                Show Bulk WG Commands
              </button>
            </div>
          </div>
        </div>

        <!-- Bulk Command Box (hidden by default) -->
        <div id="bulkCommandBox" class="hidden" style="margin-bottom: 2rem;">
          <h3 style="margin: 0 0 0.5rem 0;">Bulk Registration Commands</h3>
          <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
            Run these commands on the WireGuard server to register all pending peers:
          </p>
          <div class="command-box">
            <button class="copy-btn" onclick="copyBulkCommand()">Copy</button>
            <code id="bulkCommandCode">Loading...</code>
          </div>
        </div>

        <!-- Pending Peers -->
        <div class="card" style="margin-bottom: 2rem;">
          <div class="card-body">
            <h2 style="margin: 0 0 1rem 0;">
              Pending Peer Registrations
              <span id="pendingBadge" class="badge" style="margin-left: 0.5rem; background: var(--warning-500);">0</span>
            </h2>
            <div id="pendingPeersList">
              <p style="color: var(--gray-500);">Loading...</p>
            </div>
          </div>
        </div>

        <!-- All Peers -->
        <div class="card">
          <div class="card-body">
            <h2 style="margin: 0 0 1rem 0;">
              All VPN Peers
              <span id="allBadge" class="badge" style="margin-left: 0.5rem;">0</span>
            </h2>
            <div id="allPeersList">
              <p style="color: var(--gray-500);">Loading...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 SecureWave VPN Admin Console</p>
    </div>
  </footer>

  <script src="/js/main.js"></script>
  <script>
    // State
    let pendingPeers = [];
    let allPeers = [];
    let servers = [];

    // API Helper
    async function api(endpoint, method = 'GET', body = null) {
      const token = localStorage.getItem('access_token');
      const options = {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(endpoint, options);
      if (response.status === 401) {
        window.location.href = '/login.html';
        throw new Error('Unauthorized');
      }
      if (response.status === 403) {
        throw new Error('Admin access required');
      }
      return response;
    }

    // Load all data
    async function loadData() {
      try {
        // Load pending peers
        const pendingResp = await api('/api/admin/peers/pending');
        if (pendingResp.ok) {
          pendingPeers = await pendingResp.json();
        }

        // Load all peers
        const allResp = await api('/api/admin/peers/all');
        if (allResp.ok) {
          allPeers = await allResp.json();
        }

        // Load servers
        const serversResp = await api('/api/admin/servers/');
        if (serversResp.ok) {
          servers = await serversResp.json();
        }

        // Update UI
        updateUI();

        // Hide loading, show content
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('adminContent').classList.remove('hidden');

      } catch (error) {
        console.error('Load error:', error);
        if (error.message === 'Admin access required') {
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('accessDenied').classList.remove('hidden');
        } else {
          showMessage('error', `Failed to load data: ${error.message}`);
        }
      }
    }

    // Update UI with data
    function updateUI() {
      const registered = allPeers.filter(p => p.registered).length;
      const pending = allPeers.filter(p => !p.registered).length;

      // Stats
      document.getElementById('totalPeersCount').textContent = allPeers.length;
      document.getElementById('pendingPeersCount').textContent = pending;
      document.getElementById('registeredPeersCount').textContent = registered;
      document.getElementById('serverCount').textContent = servers.length;

      // Badges
      document.getElementById('pendingBadge').textContent = pending;
      document.getElementById('allBadge').textContent = allPeers.length;

      // Server info
      if (servers.length > 0) {
        const server = servers[0];
        document.getElementById('serverIdDisplay').textContent = server.server_id;
        document.getElementById('serverIpDisplay').textContent = server.public_ip;
        document.getElementById('serverKeyDisplay').textContent = server.wg_public_key;
        document.getElementById('serverStatusDisplay').textContent = `${server.status} (${server.health_status})`;
      }

      // Pending peers list
      const pendingList = document.getElementById('pendingPeersList');
      if (pendingPeers.length === 0) {
        pendingList.innerHTML = '<p style="color: var(--gray-500);">No pending peer registrations.</p>';
      } else {
        pendingList.innerHTML = pendingPeers.map(peer => renderPeerCard(peer, true)).join('');
      }

      // All peers list
      const allList = document.getElementById('allPeersList');
      if (allPeers.length === 0) {
        allList.innerHTML = '<p style="color: var(--gray-500);">No VPN peers yet.</p>';
      } else {
        allList.innerHTML = allPeers.map(peer => renderPeerCard(peer, false)).join('');
      }

      // Update bulk command
      updateBulkCommand();
    }

    // Render peer card
    function renderPeerCard(peer, showRegister = false) {
      const statusClass = peer.registered ? 'registered' : 'pending';
      const statusText = peer.registered ? 'Registered' : 'Pending';
      const statusColor = peer.registered ? 'var(--success-600)' : 'var(--warning-600)';

      return `
        <div class="peer-card ${statusClass}">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${peer.email}</div>
              <div style="font-size: 0.875rem; color: var(--gray-600);">User ID: ${peer.user_id}</div>
              <div style="font-size: 0.875rem; color: var(--gray-600);">IP: ${peer.client_ip}</div>
              <div style="margin-top: 0.5rem;">
                <span style="font-size: 0.75rem; font-weight: 600; color: ${statusColor};">${statusText}</span>
              </div>
            </div>
            <div style="flex: 2; min-width: 300px;">
              <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.25rem;">Public Key:</div>
              <div class="peer-key">${peer.client_public_key}</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              ${showRegister && !peer.registered ? `
                <button class="btn btn-primary btn-sm" onclick="registerPeer(${peer.user_id})">
                  Register
                </button>
              ` : ''}
              <button class="btn btn-outline btn-sm" onclick="showCommand(${peer.user_id})">
                Show Command
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Register a single peer
    async function registerPeer(userId) {
      showMessage('info', `Registering peer for user ${userId}...`);

      try {
        const resp = await api('/api/admin/peers/register', 'POST', { user_id: userId });
        const data = await resp.json();

        if (data.success) {
          showMessage('success', data.message);
          await loadData(); // Refresh
        } else {
          showMessage('error', data.message || 'Registration failed');
          // Show the command for manual registration
          if (data.wg_command) {
            showCommandDialog(data.wg_command);
          }
        }
      } catch (error) {
        showMessage('error', `Error: ${error.message}`);
      }
    }

    // Register all pending peers
    async function registerAllPeers() {
      if (pendingPeers.length === 0) {
        showMessage('info', 'No pending peers to register.');
        return;
      }

      const btn = document.getElementById('registerAllBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Registering...';

      try {
        const resp = await api('/api/admin/peers/register-all', 'POST');
        const data = await resp.json();

        if (data.registered > 0) {
          showMessage('success', data.message);
        } else {
          showMessage('error', data.message || 'No peers registered');
          if (data.command) {
            document.getElementById('bulkCommandCode').textContent = data.command;
            document.getElementById('bulkCommandBox').classList.remove('hidden');
          }
        }

        await loadData(); // Refresh
      } catch (error) {
        showMessage('error', `Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Register All Pending Peers';
      }
    }

    // Show command for a peer
    async function showCommand(userId) {
      try {
        const resp = await api(`/api/admin/peers/command/${userId}`);
        const data = await resp.json();

        const command = `${data.wg_command}\n${data.persist_command}`;
        showCommandDialog(command);
      } catch (error) {
        showMessage('error', `Error: ${error.message}`);
      }
    }

    // Show command dialog
    function showCommandDialog(command) {
      const existing = document.getElementById('commandDialog');
      if (existing) existing.remove();

      const dialog = document.createElement('div');
      dialog.id = 'commandDialog';
      dialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 1000;
      `;
      dialog.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%;">
          <h3 style="margin: 0 0 1rem 0;">WireGuard Command</h3>
          <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
            Run this command on the WireGuard server:
          </p>
          <div class="command-box" style="margin-bottom: 1rem;">
            <code>${command}</code>
          </div>
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="copyToClipboard('${command.replace(/'/g, "\\'")}')">Copy</button>
            <button class="btn btn-primary" onclick="this.closest('#commandDialog').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(dialog);
      dialog.addEventListener('click', e => {
        if (e.target === dialog) dialog.remove();
      });
    }

    // Update bulk command display
    function updateBulkCommand() {
      const pendingOnly = allPeers.filter(p => !p.registered);
      if (pendingOnly.length === 0) {
        document.getElementById('bulkCommandCode').textContent = '# No pending peers to register';
        return;
      }

      const commands = pendingOnly.map(p =>
        `sudo wg set wg0 peer ${p.client_public_key} allowed-ips ${p.client_ip}`
      );
      commands.push('sudo wg-quick save wg0');

      document.getElementById('bulkCommandCode').textContent = commands.join('\n');
    }

    // Copy bulk command
    function copyBulkCommand() {
      const command = document.getElementById('bulkCommandCode').textContent;
      copyToClipboard(command);
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('success', 'Copied to clipboard!');
      });
    }

    // Show status message
    function showMessage(type, message) {
      const el = document.getElementById('statusMessage');
      el.className = `alert ${type}`;
      el.textContent = message;
      el.classList.remove('hidden');

      setTimeout(() => {
        el.classList.add('hidden');
      }, 5000);
    }

    // Event listeners
    document.getElementById('registerAllBtn').addEventListener('click', registerAllPeers);
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('showBulkCommandBtn').addEventListener('click', () => {
      document.getElementById('bulkCommandBox').classList.toggle('hidden');
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = '/login.html';
    });

    // Initialize
    const token = localStorage.getItem('access_token');
    if (!token) {
      window.location.href = '/login.html';
    } else {
      loadData();
    }
  </script>
</body>
</html>
