import 'package:flutter/foundation.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../config/app_config.dart';
import '../logging/app_logger.dart';
import '../services/secure_storage.dart';
import '../state/adblock_state.dart';
import '../state/vpn_state.dart';

enum BootStatus { initializing, ready, failed }

class BootState {
  const BootState({
    required this.status,
    this.errorMessage,
  });

  final BootStatus status;
  final String? errorMessage;

  BootState copyWith({BootStatus? status, String? errorMessage}) {
    return BootState(
      status: status ?? this.status,
      errorMessage: errorMessage ?? this.errorMessage,
    );
  }
}

final bootControllerProvider = ChangeNotifierProvider<BootController>((ref) {
  return BootController(ref);
});

class BootController extends ChangeNotifier {
  BootController(this._ref) {
    _initialize();
  }

  final Ref _ref;
  BootState _state = const BootState(status: BootStatus.initializing);

  BootState get state => _state;

  Future<void> _initialize() async {
    AppLogger.info('Boot: start');
    try {
      final config = await AppConfig.load();
      _ref.read(appConfigProvider.notifier).state = config;

      final storage = SecureStorage();
      final selectedServer = await storage.getString(SecureStorage.selectedServerKey);
      if (selectedServer != null) {
        _ref.read(vpnStateProvider.notifier).selectServer(selectedServer);
        AppLogger.info('Boot: restored server $selectedServer');
      }

      await _ref.read(adblockStateProvider.notifier).load();
      _state = _state.copyWith(status: BootStatus.ready);
      AppLogger.info('Boot: complete');
    } catch (error, stackTrace) {
      AppLogger.error('Boot failed', error: error, stackTrace: stackTrace);
      _state = _state.copyWith(
        status: BootStatus.failed,
        errorMessage: error.toString(),
      );
    }
    notifyListeners();
  }
}
