import 'dart:async';

import 'package:dio/dio.dart';
import 'package:flutter/services.dart';

class DomainMatcher {
  DomainMatcher(this._suffixes);

  final Set<String> _suffixes;

  bool isBlocked(String domain) {
    final normalized = domain.trim().toLowerCase();
    if (normalized.isEmpty) return false;
    final parts = normalized.split('.');
    if (parts.length < 2) return false;
    var suffix = '';
    for (var i = parts.length - 1; i >= 0; i--) {
      suffix = suffix.isEmpty ? parts[i] : '${parts[i]}.$suffix';
      if (_suffixes.contains(suffix)) {
        return true;
      }
    }
    return false;
  }
}

class AdblockEngine {
  AdblockEngine({required this.fallbackAssetPath});

  final String fallbackAssetPath;
  DomainMatcher? _matcher;

  DomainMatcher? get matcher => _matcher;

  Future<int> loadFallback() async {
    final content = await rootBundle.loadString(fallbackAssetPath);
    final entries = _parseList(content);
    _matcher = DomainMatcher(entries);
    return entries.length;
  }

  Future<int> updateFromRemote(String url) async {
    final dio = Dio(BaseOptions(connectTimeout: const Duration(seconds: 10)));
    final response = await dio.get<String>(url);
    final content = response.data ?? '';
    final entries = _parseList(content);
    if (entries.isNotEmpty) {
      _matcher = DomainMatcher(entries);
    }
    return entries.length;
  }

  Set<String> _parseList(String content) {
    final lines = const LineSplitter().convert(content);
    final entries = <String>{};
    for (final line in lines) {
      final cleaned = line.trim();
      if (cleaned.isEmpty || cleaned.startsWith('#') || cleaned.startsWith('!')) {
        continue;
      }
      final token = cleaned.split(' ').first;
      final domain = token.replaceFirst('||', '').replaceAll('^', '');
      if (domain.contains('.')) {
        entries.add(domain.toLowerCase());
      }
    }
    return entries;
  }
}
